name: 'Publish to Armada'
on:
  # schedule:
  #   # Runs every hour on the hour
  #   - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      name:
        required: true


jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        repository: Synthetixio/js-monorepo
        token: ${{ secrets.TOKEN }}
    - name: Install dependencies & build
      run: |
        ls
        pwd
        cd v2/ui
        yarn install
        yarn build
        ls
        pwd
    - name: Publish armada release
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}
      run: |
        bundle_filename="$(npx --package=armada-cli@0.2.1 --yes armada bundle create ${{ github.event.inputs.name }} v2/ui/out)"
        
        hash="$(npx --package=armada-cli@0.2.1 --yes armada bundle checksum $bundle_filename)"

        checksum_filename="${filename}_SHA256SUM"
        echo "$hash" > $checksum_filename

        gh release create -R $GITHUB_REPOSITORY ${{ github.event.inputs.name }}
        gh release upload -R $GITHUB_REPOSITORY ${{ github.event.inputs.name }} $bundle_filename
        gh release upload -R $GITHUB_REPOSITORY ${{ github.event.inputs.name }} $checksum_filename

        # TODO publish bundle